<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #fff;
            border-bottom: 1px solid #e1e5e9;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .stat-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat-icon.answered {
            background-color: #10b981;
        }

        .stat-icon.pending {
            background-color: #f59e0b;
        }

        .stat-icon.rating {
            background-color: #fbbf24;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 320px;
            background-color: #fff;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }

        .search-container {
            padding: 16px;
            border-bottom: 1px solid #e1e5e9;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background-color: #f9fafb;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: #fff;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover {
            background-color: #f9fafb;
        }

        .conversation-item.active {
            background-color: #eff6ff;
            border-right: 3px solid #3b82f6;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
        }

        .time {
            font-size: 12px;
            color: #6b7280;
        }

        .message-preview {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-badge.pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-badge.answered {
            background-color: #d1fae5;
            color: #065f46;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .star {
            color: #fbbf24;
            font-size: 14px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fff;
        }

        .empty-state {
            text-align: center;
            color: #6b7280;
        }

        .empty-state-icon {
            width: 48px;
            height: 48px;
            background-color: #f3f4f6;
            border-radius: 8px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-right: 12px;
        }

        .conversation-item-content {
            display: flex;
            align-items: flex-start;
            width: 100%;
        }

        .conversation-details {
            flex: 1;
        }

        .unread-count {
            background-color: #3b82f6;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }

            .main-content {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Expert Dashboard</h1>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-icon answered"></div>
                <span>Total Answered</span>
                <strong>1</strong>
            </div>
            <div class="stat-item">
                <div class="stat-icon pending"></div>
                <span>Pending</span>
                <strong>1</strong>
            </div>
            <div class="stat-item">
                <div class="stat-icon rating"></div>
                <span>Avg Rating</span>
                <strong>1</strong>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search conversations..." />
            </div>



            <div class="conversation-list">
                <% doubts.forEach(({ lastMessage, farmer })=> { %>
                    <div class="conversation-item"
                        onclick="window.location.href='/experts/chat?id=<%= lastMessage.roomId %>'">
                        <div class="conversation-item-content">
                            <div class="user-avatar">
                                <%= farmer.name.charAt(0).toUpperCase() %>
                            </div>
                            <div class="conversation-details">
                                <div class="conversation-header">
                                    <span class="user-name">
                                        <%= farmer.name %>
                                    </span>
                                    <span class="time">
                                        <%= new Date(lastMessage.timestamp).toLocaleTimeString('en-IN') %>
                                    </span>
                                </div>
                                <div class="message-preview">
                                    <%= lastMessage.content %>
                                </div>
                                <div class="conversation-footer">
                                    <span class="status-badge answered">âœ“ Answered</span>
                                    <div class="rating">
                                        <span class="star">â˜…</span>
                                        <span>5</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div> <!-- âœ… Add this closing wrapper -->



        </div>
    </div>

    <div class="main-content">
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ’¬</div>
            <p>Select a conversation to start responding</p>
        </div>
    </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const expertId = "<%= expertId %>";
        const socket = io();
        socket.emit("registerExpert", "<%= expertId %>");


        socket.on("newMessageInDashboard", ({ senderId, message, roomId, senderName }) => {
            console.log("ðŸ“© New message received in dashboard:", message);

            const chatList = document.querySelector(".conversation-list");
            const newDiv = document.createElement("div");
            newDiv.className = "conversation-item";
            newDiv.innerHTML = `
        <div onclick="location.href='/experts/chat?id=${roomId}&farmerId=${senderId}'" class="conversation-item-content">
            <div class="user-avatar">${senderName.charAt(0).toUpperCase()}</div>
            <div class="conversation-details">
                <div class="conversation-header">
                    <span class="user-name">${senderName}</span>
                    <span class="time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-preview">${message}</div>
            </div>
        </div>
    `;
            if (chatList) chatList.prepend(newDiv);
        });


        function selectConversation(id) {
            // Remove active class from all items
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked item
            event.currentTarget.classList.add('active');

            // Here you would typically load the conversation content
            console.log('Selected conversation:', id);

            // Update main content area
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div style="padding: 20px; width: 100%; max-width: 800px;">
                    <h2>Loading conversation...</h2>
                    <p>Conversation ID: ${id}</p>
                </div>
            `;
        }

        // Search functionality
        document.querySelector('.search-input').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const conversations = document.querySelectorAll('.conversation-item');

            conversations.forEach(item => {
                const userName = item.querySelector('.user-name').textContent.toLowerCase();
                const messagePreview = item.querySelector('.message-preview').textContent.toLowerCase();

                if (userName.includes(searchTerm) || messagePreview.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>